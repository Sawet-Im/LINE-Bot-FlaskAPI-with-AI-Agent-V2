<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | AI Chat Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word; /* To handle long strings */
        }
        .clickable-message-bubble {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .clickable-message-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center">

    <div class="w-full max-w-6xl bg-white rounded-xl shadow-lg p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î AI Chat Agent</h1>
            <a href="/" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
                </svg>
                ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            </a>
        </div>

        <div class="flex items-center space-x-2 mb-4">
            <input type="checkbox" id="auto-reply-toggle" class="form-checkbox h-5 w-5 text-indigo-600">
            <label for="auto-reply-toggle" class="text-sm text-gray-700">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label>
        </div>

        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-pending" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none">
                ‡πÅ‡∏ä‡∏ó‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏≠‡∏ö
            </button>
            <button id="tab-responded" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none">
                ‡πÅ‡∏ä‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            </button>
            <button id="tab-resolved" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none">
                ‡πÅ‡∏ä‡∏ó‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1 bg-gray-50 rounded-lg p-4 shadow-sm h-[40rem] overflow-y-auto" id="chat-list-panel">
                <p id="chat-list-placeholder" class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ä‡∏ó‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</p>
            </div>
            <div class="md:col-span-2 bg-white rounded-lg p-4 shadow-sm flex flex-col h-[40rem]" id="chat-detail-panel">
                <p id="chat-detail-placeholder" class="text-center text-gray-500 mt-20">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
            </div>
        </div>
    </div>
    
    <div id="chat-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ä‡∏ó</h2>
            <div id="modal-chat-timeline" class="flex-grow overflow-y-auto space-y-4 pr-2">
                </div>
            <div id="modal-reply-form-container" class="mt-4 border-t pt-4">
                </div>
        </div>
    </div>
    <script>
        const userId = window.location.pathname.split('/').pop();
        const chatListPanel = document.getElementById('chat-list-panel');
        const chatDetailPanel = document.getElementById('chat-detail-panel');
        const autoReplyToggle = document.getElementById('auto-reply-toggle');
        
        const chatModal = document.getElementById('chat-modal');
        const modalChatTimeline = document.getElementById('modal-chat-timeline');
        const modalReplyFormContainer = document.getElementById('modal-reply-form-container');
        const closeModalBtn = document.getElementById('close-modal');

        let currentTab = 'Awaiting_Approval';
        let selectedLineId = null;

        // **‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á task ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        let currentSelectedTask = null;

        const tabs = {
            'tab-pending': 'Awaiting_Approval',
            'tab-responded': 'Responded',
            'tab-resolved': 'Resolved'
        };

        const colors = [
            '#E6E6FA', '#B0E0E6', '#F5F5DC', '#AFEEEE', '#F08080', '#FFDAB9', '#DDA0DD', '#FFE4B5'
        ];
        let colorIndex = 0;
        const taskColors = {};

        function getTaskColor(taskId) {
            if (!taskColors[taskId]) {
                taskColors[taskId] = colors[colorIndex % colors.length];
                colorIndex++;
            }
            return taskColors[taskId];
        }

        async function fetchAutoReplySetting() {
            try {
                const response = await fetch(`/api/auto_reply_setting/${userId}`);
                const data = await response.json();
                autoReplyToggle.checked = data.is_enabled;
            } catch (error) {
                console.error("Error fetching auto-reply setting:", error);
            }
        }

        autoReplyToggle.addEventListener('change', async (e) => {
            const isEnabled = e.target.checked;
            try {
                const response = await fetch(`/api/update_auto_reply_setting/${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_enabled: isEnabled })
                });
                if (!response.ok) {
                    throw new Error('Failed to update setting');
                }
                console.log(`Auto-reply setting updated to ${isEnabled}`);
            } catch (error) {
                console.error("Error updating auto-reply setting:", error);
                e.target.checked = !isEnabled;
            }
        });

        function activateTab(tabId) {
            Object.keys(tabs).forEach(id => {
                const button = document.getElementById(id);
                if (id === tabId) {
                    button.classList.add('border-indigo-500', 'text-indigo-600');
                    button.classList.remove('border-transparent', 'text-gray-500');
                } else {
                    button.classList.remove('border-indigo-500', 'text-indigo-600');
                    button.classList.add('border-transparent', 'text-gray-500');
                }
            });
        }

        async function fetchTasksAndGroup(status) {
            try {
                const response = await fetch(`/api/tasks/${userId}/${status}`);
                const tasks = await response.json();

                console.log(`Tasks received for status ${status}:`, tasks);
                const groupedTasks = {};
                tasks.forEach(task => {
                    const lineId = task.line_id;
                    if (!groupedTasks[lineId]) {
                        groupedTasks[lineId] = [];
                    }
                    groupedTasks[lineId].push(task);
                });
                
                // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á
                renderChatList(groupedTasks); 
                
            } catch (error) {
                console.error('Error fetching tasks:', error);
                chatListPanel.innerHTML = `<p class="text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ä‡∏ó</p>`;
            }
        }

        function renderChatList(groupedTasks) {
            chatListPanel.innerHTML = '';
            const lineIds = Object.keys(groupedTasks);
            if (lineIds.length === 0) {
                chatListPanel.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ä‡∏ó‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</p>`;
                return;
            }
            lineIds.forEach(lineId => {
                const latestTask = groupedTasks[lineId][0];
                const isSelected = selectedLineId === lineId;
                const listItem = document.createElement('div');
                listItem.className = `p-3 rounded-lg cursor-pointer transition-colors duration-200 mb-2 ${isSelected ? 'bg-indigo-100 border-l-4 border-indigo-500' : 'hover:bg-gray-200'}`;
                listItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-gray-800">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (${lineId.slice(0, 8)}...)</span>
                        <span class="text-xs text-gray-500">${new Date(latestTask.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1 truncate">${latestTask.user_message}</p>
                `;
                listItem.addEventListener('click', () => {
                    selectedLineId = lineId;
                    // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á
                    currentSelectedTask = latestTask;
                    renderChatDetail(latestTask);
                    fetchTasksAndGroup(currentTab);
                });
                chatListPanel.appendChild(listItem);
            });
        }
        
        async function renderChatDetail(task) {
            chatDetailPanel.innerHTML = '';
            
            const response = await fetch(`/api/chat_history/${userId}/${task.line_id}`);
            const chatHistory = await response.json();

            const timelineContainer = document.createElement('div');
            timelineContainer.className = 'flex-grow overflow-y-auto space-y-4 pr-2';
            
            chatHistory.forEach(historyTask => {
                const bubbleColor = getTaskColor(historyTask.task_id);

                // User message bubble (clickable)
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'flex justify-end';
                const userBubble = document.createElement('div');
                userBubble.className = 'message-bubble text-gray-800 clickable-message-bubble';
                userBubble.style.backgroundColor = bubbleColor;
                userBubble.textContent = historyTask.user_message;
                userBubble.addEventListener('click', () => {
                    // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal
                    currentSelectedTask = historyTask;
                    showChatModal(historyTask);
                });
                userMessageDiv.appendChild(userBubble);
                timelineContainer.appendChild(userMessageDiv);
                
                // AI response bubble
                if (historyTask.ai_response && historyTask.ai_response.trim() !== '') {
                    const aiResponseDiv = document.createElement('div');
                    aiResponseDiv.className = 'flex justify-start';
                    aiResponseDiv.innerHTML = `<div class="message-bubble text-gray-600" style="background-color: ${bubbleColor};">${historyTask.ai_response}</div>`;
                    timelineContainer.appendChild(aiResponseDiv);
                }
                
                // Admin response bubble
                if (historyTask.admin_response && historyTask.admin_response.trim() !== '') {
                     const adminResponseDiv = document.createElement('div');
                    adminResponseDiv.className = 'flex justify-start';
                    adminResponseDiv.innerHTML = `<div class="message-bubble text-gray-600" style="background-color: ${bubbleColor};">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${historyTask.admin_response}</div>`;
                    timelineContainer.appendChild(adminResponseDiv);
                }
            });

            chatDetailPanel.appendChild(timelineContainer);

            // Reply form at the bottom of the right panel
            const replyFormHtml = `
                <div class="mt-4 border-t pt-4">
                    <form id="reply-form" class="flex flex-col space-y-2">
                        <textarea id="reply-message" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö...">${task.ai_response || ''}</textarea>
                        
                        <div class="flex space-x-2">
                            <button type="submit" id="send-btn" class="flex-grow bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300">
                                ‡∏™‡πà‡∏á
                            </button>
                        </div>
                    </form>
                </div>
            `;
            chatDetailPanel.insertAdjacentHTML('beforeend', replyFormHtml);
        }
        
        async function showChatModal(task) {
            modalChatTimeline.innerHTML = '';
            modalReplyFormContainer.innerHTML = '';
            
            // ‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            const aiResponse = task.ai_response || '';
            const sqlKeyword = "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á SQL ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:";
            let aiResponseText = aiResponse;
            let sqlCommand = '';

            if (aiResponse.includes(sqlKeyword)) {
                const parts = aiResponse.split(sqlKeyword);
                aiResponseText = parts[0];
                sqlCommand = sqlKeyword + parts[1];
            }
            
            const bubbleColor = getTaskColor(task.task_id);

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'flex justify-end';
            userMessageDiv.innerHTML = `<div class="message-bubble text-gray-800" style="background-color: ${bubbleColor};">${task.user_message}</div>`;
            modalChatTimeline.appendChild(userMessageDiv);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á AI
            if (aiResponseText.trim() !== '') {
                const aiResponseDiv = document.createElement('div');
                aiResponseDiv.className = 'flex justify-start';
                aiResponseDiv.innerHTML = `<div class="message-bubble text-gray-600" style="background-color: ${bubbleColor};">${aiResponseText}</div>`;
                modalChatTimeline.appendChild(aiResponseDiv);
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á SQL ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î
            if (sqlCommand.trim() !== '') {
                const sqlDiv = document.createElement('div');
                sqlDiv.className = 'flex justify-start';
                sqlDiv.innerHTML = `<div class="p-3 text-sm bg-gray-200 rounded-lg max-w-full overflow-x-auto"><strong>${sqlCommand}</strong></div>`;
                modalChatTimeline.appendChild(sqlDiv);
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
            const replyFormHtml = `
                <div class="mt-4 border-t pt-4">
                    <form id="modal-reply-form" class="flex flex-col space-y-2">
                        <textarea id="reply-message" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö...">${task.ai_response || ''}</textarea>
                        
                        <div class="flex space-x-2">
                            <button type="submit" id="send-btn" class="flex-grow bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300">
                                ‡∏™‡πà‡∏á
                            </button>
                        </div>
                    </form>
                </div>
            `;
            modalReplyFormContainer.insertAdjacentHTML('beforeend', replyFormHtml);
            
            chatModal.style.display = 'flex';
        }

        function closeChatModal() {
            chatModal.style.display = 'none';
        }

        closeModalBtn.addEventListener('click', closeChatModal);

        // **‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**: ‡∏™‡∏£‡πâ‡∏≤‡∏á Event Listener ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        document.addEventListener('submit', async (e) => {
            if (e.target && (e.target.id === 'reply-form' || e.target.id === 'modal-reply-form')) {
                e.preventDefault();
                const replyMessage = e.target.querySelector('#reply-message').value;

                if (!replyMessage || !currentSelectedTask) {
                    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ä‡∏ó‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å!');
                    return;
                }
                
                const taskId = currentSelectedTask.task_id;
                const lineId = currentSelectedTask.line_id;
                const storeId = userId; // storeId ‡∏Ñ‡∏∑‡∏≠ userId ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß

                const response = await fetch(`/api/send_admin_reply/${lineId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        taskId: taskId,
                        replyMessage: replyMessage,
                        storeId: storeId
                    })
                });

                if (response.ok) {
                    alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    e.target.querySelector('#reply-message').value = '';
                    closeChatModal();
                    fetchTasksAndGroup(currentTab);
                    chatDetailPanel.innerHTML = `<p class="text-center text-gray-500 mt-20">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>`;
                } else {
                    const data = await response.json();
                    alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.message}`);
                }
            }
        });

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            fetchAutoReplySetting();
            fetchTasksAndGroup(currentTab);
            activateTab('tab-pending');
        });

        Object.keys(tabs).forEach(tabId => {
            document.getElementById(tabId).addEventListener('click', () => {
                currentTab = tabs[tabId];
                activateTab(tabId);
                fetchTasksAndGroup(currentTab);
                chatDetailPanel.innerHTML = `<p class="text-center text-gray-500 mt-20">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>`;
            });
        });
    </script>
</body>
</html>