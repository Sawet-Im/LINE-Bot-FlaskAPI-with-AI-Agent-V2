# LINE Bot Flask with AI Agent V2
р╣Вр╕Ыр╕гр╣Ар╕Ир╕Др╕Щр╕╡р╣Йр╕Др╕╖р╕нр╕Ър╕нр╕Чр╕нр╕▒р╕Ир╕Йр╕гр╕┤р╕вр╕░р╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Вр╕бр╣Ар╕Фр╕ер╕ар╕▓р╕йр╕▓р╕Вр╕Щр╕▓р╕Фр╣Гр╕лр╕Нр╣И (LLM) р╕нр╕вр╣Ир╕▓р╕З Google Gemini р╕гр╣Ир╕зр╕бр╕Бр╕▒р╕Ър╣Ар╕Яр╕гр╕бр╣Ар╕зр╕┤р╕гр╣Мр╕Б LangChain р╣Ар╕Юр╕╖р╣Ир╕нр╕Чр╕│р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щ AI Agent р╣Гр╕Щр╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Бр╕ер╕░р╕Хр╕нр╕Ър╕Др╕│р╕Цр╕▓р╕бр╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Бр╕▒р╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓/р╕Ър╕гр╕┤р╕Бр╕▓р╕гр╕Вр╕нр╕Зр╕гр╣Йр╕▓р╕Щр╕Др╣Йр╕▓ р╣Вр╕Фр╕вр╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е SQL (SQLite) р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╣Йр╕Щр╕лр╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕бр╕Щр╕╣ р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╕Щ р╕Фр╣Йр╕зр╕вр╕Хр╕▒р╕зр╣Ар╕нр╕З р╕Юр╕гр╣Йр╕нр╕бFlaskAPI р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ LINE Messaging API р╣Вр╕Фр╕вр╕Ир╕░р╕Чр╕│р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щ Webhook р╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕▒р╕Ъ-р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б р╣Бр╕ер╕░р╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕е Channel API р╕ер╕Зр╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е SQLite р╣Др╕Фр╣Й

# ЁЯМЯ р╕Др╕╕р╕Ур╕кр╕бр╕Ър╕▒р╕Хр╕┤р╕лр╕ер╕▒р╕Б
* SQL Access via Agent: Agent р╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╕гр╣Йр╕▓р╕Зр╣Бр╕ер╕░р╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕З SQL (SELECT, INSERT, UPDATE) р╕Бр╕▒р╕Ър╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е SQLite р╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕Ър╕Ъ Real-time
* Dynamic Context & Filtering: Agent р╕Цр╕╣р╕Бр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Гр╕лр╣Йр╕гр╕▒р╕Ъ Store ID р╣Бр╕ер╕░ Store Name р╕Хр╕▒р╣Йр╕Зр╣Бр╕Хр╣Ир╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ р╕Чр╕│р╣Гр╕лр╣Йр╕Бр╕▓р╕гр╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щ SQL р╣Бр╕бр╣Ир╕Щр╕вр╕│р╣Бр╕ер╕░р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕Бр╕▓р╕гр╕Вр╣Йр╕▓р╕бр╕гр╣Йр╕▓р╕Щр╕Др╣Йр╕▓р╣Др╕Фр╣Й
* Conversation Memory: р╣Гр╕Кр╣Й ConversationBufferMemory р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Бр╣Зр╕Ър╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓ р╕Чр╕│р╣Гр╕лр╣Й Agent р╕Ир╕Фр╕Ир╕│р╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Фр╕Вр╕нр╕Зр╕ер╕╣р╕Бр╕Др╣Йр╕▓ (р╣Ар╕Кр╣Ир╕Щ "р╣Др╕бр╣Ир╕Чр╕▓р╕Щр╣Ар╕Щр╕╖р╣Йр╕н", "р╣Бр╕Юр╣Йр╕нр╕▓р╕лр╕▓р╕гр╕Чр╕░р╣Ар╕е") р╣Бр╕ер╕░р╕гр╕зр╕бр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╣Гр╕Щр╕Бр╕▓р╕гр╕Др╣Йр╕Щр╕лр╕▓р╣Ар╕бр╕Щр╕╣р╣Др╕Фр╣Й
* API Integration: р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ LINE Messaging API р╕Ьр╣Ир╕▓р╕Щ Webhook р╣Бр╕ер╕░р╣Гр╕Кр╣Й Flask/Gunicorn р╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕нр╕Зр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╣Гр╕Щ Production
* р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н Webhook LINE р╣Гр╕лр╣Йр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
* р╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕ер╕╖р╕нр╕Бр╣Гр╕лр╣Й AI р╕Хр╕нр╕Ър╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤ р╕лр╕гр╕╖р╕н AI р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Гр╕лр╣Й admin р╣Бр╕Бр╣Йр╣Др╕Вр╕Др╕│р╕Хр╕нр╕Ър╣Др╕Фр╣Й

# 1. р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣М
р╣Вр╕Ыр╕гр╕Фр╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╣Бр╕ер╕░р╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╕Хр╕▓р╕бр╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕Фр╣Йр╕▓р╕Щр╕ер╣Ир╕▓р╕Зр╕Щр╕╡р╣Й:
```
тФЬтФАтФА templates/
тФВ   тФЬтФАтФА dashboard.html    # dashboard р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Фр╕╣р╣Бр╕Кр╕Ч
тФВ   тФЬтФАтФА setup.html        # р╕Бр╕гр╕нр╕Б Channel Secret р╣Бр╕ер╕░ Channel Access Token р╕Вр╕нр╕Зр╕Др╕╕р╕У
тФЬтФАтФА my_app/
тФВ   тФЬтФАтФА api_app.py        # р╣Др╕Яр╕ер╣М FlaskAPI р╕лр╕ер╕▒р╕Бр╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕▒р╕Щ Webhook
тФВ   тФЬтФАтФА admin_app.py      # Streamlit UI р╕кр╕│р╕лр╕гр╕▒р╕Ъ Admin
тФВ   тФЬтФАтФА ai_processor.py   # Logic р╕лр╕ер╕▒р╕Б: р╕гр╕▒р╕Ъ task, р╣Ар╕гр╕╡р╕вр╕Б Agent, р╕Ир╕▒р╕Фр╕Бр╕▓р╕г Error/Retry Logic
тФВ   тФЬтФАтФА database.py       # р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н SQLite, р╕Бр╕▓р╕гр╕Фр╕╢р╕З Store Info р╣Бр╕ер╕░ Chat History
тФВ   тФФтФАтФА agent_setup.py    # р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Бр╕▓р╕гр╕кр╕гр╣Йр╕▓р╕З LLM, SQL Toolkit, Memory, р╣Бр╕ер╕░ Agent Executor
тФЬтФАтФА .env                  # р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ API Key р╣Бр╕ер╕░ DB URI
тФЬтФАтФА requirements.txt      # р╕гр╕▓р╕вр╕Бр╕▓р╕гр╣Др╕ер╕Ър╕гр╕▓р╕гр╕╡р╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ
тФФтФАтФА README.md             # р╣Др╕Яр╕ер╣Мр╕Др╕╣р╣Ир╕бр╕╖р╕нр╕Щр╕╡р╣Й
```

# 2. р╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓

## 2.1. р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕Бр╣Ир╕нр╕Щр╣Ар╕гр╕┤р╣Ир╕б
* Python 3.7 р╕лр╕гр╕╖р╕нр╣Гр╕лр╕бр╣Ир╕Бр╕зр╣Ир╕▓
* pip (р╕Хр╕▒р╕зр╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Бр╕Юр╣Зр╕Бр╣Ар╕Бр╕Ир╕Вр╕нр╕З Python)
* ngrok (р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Ыр╕┤р╕Ф Local Server р╣Гр╕лр╣Йр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╣Др╕Фр╣Йр╕Ир╕▓р╕Бр╕ар╕▓р╕вр╕Щр╕нр╕Б)

## 2.2. р╕кр╕гр╣Йр╕▓р╕З Environment р╣Бр╕ер╕░р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Dependencies:
```
python -m venv venv
source venv/bin/activate  # р╕Ър╕Щ Windows р╣Гр╕Кр╣Й `venv\Scripts\activate`
```
р╣Др╕Яр╕ер╣М requirements.txt
р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Др╕ер╕Ър╕гр╕▓р╕гр╕╡р╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Фр╣Йр╕зр╕вр╕Др╕│р╕кр╕▒р╣Ир╕З:
```
pip install -r requirements.txt
```

## 2.3 р╕кр╕гр╣Йр╕▓р╕Зр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ:
р╕гр╕▒р╕Щр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ initialize_db() р╣Гр╕Щ database.py р╕лр╕гр╕╖р╕нр╣Гр╕Кр╣Йр╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕бр╕╖р╕нр╕Чр╕╡р╣Ир╕Др╕╕р╕Ур╕Цр╕Щр╕▒р╕Ф р╣Ар╕Юр╕╖р╣Ир╕нр╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М agent_db.sqlite р╕Юр╕гр╣Йр╕нр╕бр╕Хр╕▓р╕гр╕▓р╕Зр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ (stores, menu, promotions, tasks, ingredients)

## 2.4 р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ API Key
### р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Кр╕╖р╣Ир╕н .env р╣Гр╕Щр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Ър╣Др╕Яр╕ер╣М api_app.py р╣Бр╕ер╕░р╣Ар╕Юр╕┤р╣Ир╕бр╕Др╣Ир╕▓р╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щр╕ер╕Зр╣Др╕Ыр╕Фр╕▒р╕Зр╕Щр╕╡р╣Й:
```
GOOGLE_API_KEY="YOUR_GEMINI_API_KEY"
# р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╕Фр╣Йр╕зр╕в LINE API
LINE_CHANNEL_ACCESS_TOKEN="YOUR_LINE_ACCESS_TOKEN"
LINE_CHANNEL_SECRET="YOUR_LINE_CHANNEL_SECRET"
#ngrok url
BASE_URL="NGROK_URL"
```

# 3. р╕гр╕▒р╕Щр╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣Мр╣Бр╕ер╕░р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ ngrok
##### 3.1 р╣Ар╕Ыр╕┤р╕Ф Terminal1 р╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕З ngrok р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Ыр╕┤р╕Ф Public URL:
```
ngrok http 9000
```
р╕Др╕╕р╕Ур╕Ир╕░р╣Др╕Фр╣Йр╕гр╕▒р╕Ъ Public URL р╕Чр╕╡р╣Ир╕Вр╕╢р╣Йр╕Щр╕Хр╣Йр╕Щр╕Фр╣Йр╕зр╕в https:// (р╣Ар╕Кр╣Ир╕Щ https://example.ngrok-free.app) р╣Вр╕Ыр╕гр╕Ф р╕Др╕▒р╕Фр╕ер╕нр╕Б URL р╕Щр╕╡р╣Йр╣Др╕зр╣Й
##### 3.2 р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕кр╕│р╕Др╕▒р╕Н: р╣Ар╕Ыр╕┤р╕Фр╣Др╕Яр╕ер╣М api_app.py р╣Бр╕ер╣Йр╕зр╕Щр╕│ URL р╕Чр╕╡р╣Ир╕Др╕▒р╕Фр╕ер╕нр╕Бр╕бр╕▓р╣Др╕Ыр╕зр╕▓р╕Зр╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Др╣Ир╕▓р╕Вр╕нр╕Зр╕Хр╕▒р╕зр╣Бр╕Ыр╕г base_url р╕Хр╕▓р╕бр╣Вр╕Др╣Йр╕Фр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Фр╣Йр╕▓р╕Щр╕ер╣Ир╕▓р╕З:
```
# V V V V V V V V V V V V V V V V V V V V V V V V V V V V V V
#
# >>> р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣Ир╕кр╕│р╕Др╕▒р╕Нр╕бр╕▓р╕Б: р╣Вр╕Ыр╕гр╕Фр╕Щр╕│ Public URL р╕Ир╕▓р╕Б ngrok р╕бр╕▓р╕зр╕▓р╕Зр╕Чр╕╡р╣Ир╕Щр╕╡р╣И
#
# ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^
#
BASE_URL = "[https://example.ngrok-free.app](https://example.ngrok-free.app)" # р╕зр╕▓р╕З URL ngrok р╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Чр╕╡р╣Ир╕Щр╕╡р╣И

```
## 3.3 Terminal 2 (р╕кр╕│р╕лр╕гр╕▒р╕Ъ Flask API):
р╣Ар╕Ыр╕┤р╕Ф Terminal р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╕кр╕нр╕Зр╣Бр╕ер╕░р╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕З:
```
source venv/bin/activate 
cd my_app
python api_app.py
```

# 4. р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Ър╕Щр╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ъ
##### 1. р╣Ар╕Ыр╕┤р╕Фр╣Ар╕зр╣Зр╕Ър╣Ар╕Ър╕гр╕▓р╕зр╣Мр╣Ар╕Лр╕нр╕гр╣Мр╣Бр╕ер╣Йр╕зр╣Др╕Ыр╕Чр╕╡р╣И http://localhost:9000
##### 2. р╕Бр╕гр╕нр╕Б Channel Secret р╣Бр╕ер╕░ Channel Access Token р╕Вр╕нр╕Зр╕Др╕╕р╕У
##### 3. р╕Бр╕Фр╕Ыр╕╕р╣Ир╕б "р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Бр╕ер╕░р╕кр╕гр╣Йр╕▓р╕З Webhook"
##### р╕лр╕▓р╕Бр╕Чр╕╕р╕Бр╕нр╕вр╣Ир╕▓р╕Зр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З р╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ър╕Ир╕░р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕зр╣Ир╕▓ "Webhook URL updated successfully." р╕Юр╕гр╣Йр╕нр╕бр╕Бр╕▒р╕Ъ Webhook URL р╕Чр╕╡р╣Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М


# 5. Flow р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ъ (System Data Flow)
## 5.1. р╕ар╕▓р╕Юр╕гр╕зр╕б Flow р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ
##### 1. Incoming Request (LINE): р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ьр╣Ир╕▓р╕Щ LINE
##### 2. API Gateway (Flask/Gunicorn): LINE Webhook р╕кр╣Ир╕З Payload р╕бр╕▓р╕вр╕▒р╕З api_app.py
##### 3. Core Logic (ai_processor.py): р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е Task
##### 4. Context Loading (database.py): р╕Фр╕╢р╕З Store ID, Store Name, р╣Бр╕ер╕░ Chat History р╕Ир╕▓р╕Б SQLite р╣Вр╕Фр╕вр╕Хр╕гр╕З
##### 5. Agent Initialization (agent_setup.py): р╕кр╕гр╣Йр╕▓р╕З Agent р╣Вр╕Фр╕вр╣Гр╕Кр╣Й Prompt р╕Чр╕╡р╣Ир╕бр╕╡р╕Ър╕гр╕┤р╕Ър╕Ч (Store ID) р╣Бр╕ер╕░ Memory (Chat History) р╕Чр╕╡р╣Ир╣Вр╕лр╕ер╕Фр╕бр╕▓
##### 6. Agent Invocation: Agent р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б
##### 7. Response Generation: Agent р╣Бр╕Ыр╕ер╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М SQL р╣Ар╕Ыр╣Зр╕Щр╕Др╕│р╕Хр╕нр╕Ър╕ар╕▓р╕йр╕▓р╣Др╕Чр╕вр╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕бр╕┤р╕Хр╕г
##### 8. Output Response (LINE): р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕вр╕▒р╕Зр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Ьр╣Ир╕▓р╕Щ LINE

## 5.2. р╕ер╕│р╕Фр╕▒р╕Ър╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е (Sequential Steps)
Step | р╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╕Чр╕│р╕Зр╕▓р╕Щ | р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╣Бр╕ер╕░ Context
----- | ----- | -----
1.Receive Task | line_handler.py -> ai_processor.py | р╕гр╕▒р╕Ъ user_id, line_id, р╣Бр╕ер╕░ user_message
2.Load Context | database.py | ЁЯЯв р╕Фр╕╢р╕З Context р╕Бр╣Ир╕нр╕Щр╕кр╕гр╣Йр╕▓р╕З Agent: р╣Ар╕гр╕╡р╕вр╕Б get_store_info_direct(user_id) р╣Ар╕Юр╕╖р╣Ир╕нр╕лр╕▓ store_id р╣Бр╕ер╕░ store_name
3.Build Prompt | agent_setup.py | р╣Гр╕Кр╣Й store_id р╣Бр╕ер╕░ store_name р╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕бр╕▓р╕кр╕гр╣Йр╕▓р╕З AGENT_PREFIX р╣Бр╕Ър╕Ъ Dynamic р╣Ар╕Юр╕╖р╣Ир╕нр╕Ър╕▒р╕Зр╕Др╕▒р╕Ър╕Бр╕▓р╕гр╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
4.Initialize Agent | agent_setup.py | р╕кр╕гр╣Йр╕▓р╕З SQLDatabaseToolkit р╣Бр╕ер╕░ AgentExecutor р╣Вр╕Фр╕вр╣Гр╕Кр╣Й Prompt р╕Чр╕╡р╣Ир╕бр╕╡ Context р╣Бр╕ер╕░ Memory р╕Чр╕╡р╣Ир╕бр╕╡ Chat History
5.Invoke Agent | ai_processor.py | р╣Ар╕гр╕╡р╕вр╕Б agent_executor.invoke({"input": user_message})
6.SQL Execution | Agent Tools -> SQLite | Agent р╕кр╕гр╣Йр╕▓р╕З SQL р╕Чр╕╡р╣Ир╕бр╕╡ WHERE store_id = [ID] р╣Бр╕ер╕░р╕гр╕▒р╕Щр╕Бр╕▒р╕Ър╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
7.Respond | ai_processor.py -> line_handler.py | р╕кр╣Ир╕Зр╕Др╕│р╕Хр╕нр╕Ър╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕вр╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╣Гр╕лр╣Й LINE

# 6. р╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕б Memory р╣Бр╕ер╕░р╕Бр╕▓р╕гр╣Гр╕Кр╣Й Chat History р╣Гр╕Щ Agent
р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕лр╕Щр╣Ир╕зр╕вр╕Др╕зр╕▓р╕бр╕Ир╕│ (Memory) р╣Ар╕Ыр╣Зр╕Щр╕лр╕▒р╕зр╣Гр╕Ир╕кр╕│р╕Др╕▒р╕Нр╕Чр╕╡р╣Ир╕Чр╕│р╣Гр╕лр╣Й Chatbot р╕Щр╕╡р╣Йр╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Ир╕Фр╕Ир╕│р╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓р╕Чр╕╡р╣Ир╕Ьр╣Ир╕▓р╕Щр╕бр╕▓р╣Бр╕ер╕░р╕Щр╕│р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╕▒р╣Йр╕Щр╕бр╕▓р╕Ыр╕гр╕░р╕Бр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕▒р╕Фр╕кр╕┤р╕Щр╣Гр╕Ир╣Бр╕ер╕░р╕Бр╕▓р╕гр╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З SQL р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╣Бр╕ер╕░р╕Лр╕▒р╕Ър╕Лр╣Йр╕нр╕Щр╣Др╕Фр╣Й
## 6.1. р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Бр╕ер╕░р╕Бр╕▓р╕гр╣Вр╕лр╕ер╕Фр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓
р╕нр╕Зр╕Др╣Мр╕Ыр╕гр╕░р╕Бр╕нр╕Ъ | р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф | р╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╕гр╕▒р╕Ър╕Ьр╕┤р╕Фр╕Кр╕нр╕Ъ
----- | ----- | -----
Chat History Storage | р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓ (User Message р╣Бр╕ер╕░ AI Response) р╕Ир╕░р╕Цр╕╣р╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Др╕зр╣Йр╣Гр╕Щр╕Хр╕▓р╕гр╕▓р╕З tasks р╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е SQLite | database.py
Function | р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ get_chat_history_for_memory() р╣Гр╕Щ database.py р╕Ир╕░р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕вр╣Йр╕нр╕Щр╕лр╕ер╕▒р╕Зр╕Хр╕▓р╕б user_id р╣Бр╕ер╕░ line_id р╣Гр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕Чр╕╡р╣И LangChain р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г (р╕бр╕▒р╕Бр╕Ир╕░р╕Ир╕│р╕Бр╕▒р╕Фр╕Чр╕╡р╣И 8-10 р╕Др╕╣р╣Ир╕кр╕Щр╕Чр╕Щр╕▓р╕ер╣Ир╕▓р╕кр╕╕р╕Ф) | database.py
Memory Setup | р╣Гр╕Кр╣Й ConversationBufferMemory р╕Вр╕нр╕З LangChain р╣Ар╕Юр╕╖р╣Ир╕нр╕Ир╕▒р╕Фр╣Ар╕Бр╣Зр╕Ър╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Чр╕╡р╣Ир╣Вр╕лр╕ер╕Фр╕бр╕▓р╕Ир╕▓р╕Бр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕зр╣Йр╣Гр╕Щр╕Хр╕▒р╕з Agent | agent_setup.py
## 6.2. р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕лр╕Щр╣Ир╕зр╕вр╕Др╕зр╕▓р╕бр╕Ир╕│р╣Ар╕Юр╕╖р╣Ир╕нр╕кр╕░р╕кр╕бр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕Бр╕гр╕нр╕З
р╕Бр╕▓р╕гр╣Гр╕Кр╣Й Memory р╣Гр╕Щр╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣Мр╕Щр╕╡р╣Йр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕бр╕╡р╣Ар╕Юр╕╡р╕вр╕Зр╣Бр╕Др╣Ир╕Бр╕▓р╕гр╕Ир╕Фр╕Ир╕│р╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ р╣Бр╕Хр╣Ир╣Ар╕Ыр╣Зр╕Щр╕Бр╕▓р╕г р╕Ър╕▒р╕Зр╕Др╕▒р╕Ъ Agent р╣Гр╕лр╣Йр╕гр╕зр╕бр╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Фр╕лр╕ер╕▓р╕вр╕Кр╕▒р╣Йр╕Щ р╣Ар╕Вр╣Йр╕▓р╕Фр╣Йр╕зр╕вр╕Бр╕▒р╕Щр╕Бр╣Ир╕нр╕Щр╕Ир╕░р╕гр╕▒р╕Щ SQL:
##### 1.р╕Бр╕▓р╕гр╕нр╣Ир╕▓р╕Щ History: р╣Гр╕Щр╣Др╕Яр╕ер╣М agent_setup.py р╕кр╣Ир╕зр╕Щ initialize_sql_agent р╕Ир╕░р╕бр╕╡р╕Бр╕▓р╕гр╣Вр╕лр╕ер╕Ф chat_history р╣Бр╕ер╕░р╕кр╣Ир╕Зр╣Ар╕Вр╣Йр╕▓р╣Гр╕Щ memory
##### 2.р╕Бр╕▓р╕гр╕Щр╕│р╣Др╕Ыр╣Гр╕Кр╣Йр╣Гр╕Щ Prompt: AGENT_PREFIX р╕Цр╕╣р╕Бр╣Ар╕Вр╕╡р╕вр╕Щр╕Вр╕╢р╣Йр╕Щр╣Ар╕Юр╕╖р╣Ир╕нр╕кр╕▒р╣Ир╕Зр╣Гр╕лр╣Й Agent р╕Хр╣Йр╕нр╕Зр╕нр╣Ир╕▓р╕Щ р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Гр╕Щ chat_history р╕Чр╕╕р╕Бр╕Др╕гр╕▒р╣Йр╕Зр╕Чр╕╡р╣Ир╕бр╕╡р╕Бр╕▓р╕гр╕Вр╕нр╣Бр╕Щр╕░р╕Щр╕│р╣Ар╕бр╕Щр╕╣
##### 3.р╕Бр╕▓р╕гр╕кр╕░р╕кр╕б Logic: р╣Ар╕бр╕╖р╣Ир╕нр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Хр╕нр╕Ър╕зр╣Ир╕▓ "р╣Др╕бр╣Ир╕Чр╕▓р╕Щр╕Чр╕░р╣Ар╕е" р╣Бр╕ер╣Йр╕зр╕Хр╕▓р╕бр╕Фр╣Йр╕зр╕в "р╣Др╕бр╣Ир╕Чр╕▓р╕Щр╣Ар╕Щр╕╖р╣Йр╕н" Agent р╕Ир╕░р╣Ар╕лр╣Зр╕Щр╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Фр╕Чр╕▒р╣Йр╕Зр╕кр╕нр╕Зр╣Гр╕Щ Memory р╣Бр╕ер╕░р╕Цр╕╣р╕Бр╕Ър╕▒р╕Зр╕Др╕▒р╕Ър╣Гр╕лр╣Йр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕кр╕нр╕Зр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╣Ар╕Вр╣Йр╕▓р╕Фр╣Йр╕зр╕вр╕Бр╕▒р╕Щр╣Гр╕Щр╕Др╕│р╕кр╕▒р╣Ир╕З SQL р╣Ар╕Фр╕╡р╕вр╕з р╣Ар╕Кр╣Ир╕Щ:
```
... WHERE T1.store_id = {store_id} 
AND T1.menu_id NOT IN (SELECT menu_id FROM ingredients WHERE ingredient_name LIKE '%р╕Чр╕░р╣Ар╕е%') 
AND T1.menu_id NOT IN (SELECT menu_id FROM ingredients WHERE ingredient_name LIKE '%р╣Ар╕Щр╕╖р╣Йр╕н%')
```

# 7. р╣Бр╕Щр╕зр╕Чр╕▓р╕Зр╕Бр╕▓р╕гр╕Юр╕▒р╕Тр╕Щр╕▓ Prompt р╣Бр╕ер╕░ Logic
## 7.1. р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Ър╕гр╕┤р╕Ър╕Чр╕Вр╕нр╕Зр╕гр╣Йр╕▓р╕Щр╕Др╣Йр╕▓
##### р╣Др╕Яр╕ер╣М: agent_setup.py р╣Бр╕ер╕░ database.py
* Dynamic Prompt: р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ create_agent_prefix() р╕Ир╕░р╕кр╕гр╣Йр╕▓р╕З Prompt р╕Вр╕╢р╣Йр╕Щр╕бр╕▓р╣Гр╕лр╕бр╣Ир╕Чр╕╕р╕Бр╕Др╕гр╕▒р╣Йр╕Зр╕Чр╕╡р╣И Agent р╕Цр╕╣р╕Бр╣Ар╕гр╕╡р╕вр╕Б р╣Вр╕Фр╕вр╕бр╕╡ store_id р╣Бр╕ер╕░ store_name р╕Чр╕╡р╣Ир╕Фр╕╢р╕Зр╕Ир╕▓р╕Б database.py (р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ get_store_info_direct)
* р╕Бр╕▓р╕гр╕Ър╕▒р╕Зр╕Др╕▒р╕Ър╕Бр╕гр╕нр╕З: р╣Гр╕Щр╕кр╣Ир╕зр╕Щ Core Rules р╕Вр╕нр╕З Prompt р╕Цр╕╣р╕Бр╕Бр╕│р╕лр╕Щр╕Фр╣Гр╕лр╣Й Agent р╕Хр╣Йр╕нр╕З р╣Гр╕Кр╣Й {store_id} р╣Гр╕Щр╕Чр╕╕р╕Бр╕Др╕│р╕кр╕▒р╣Ир╕З SELECT р╕Чр╕╡р╣Ир╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╕Хр╕▓р╕гр╕▓р╕З menu р╕лр╕гр╕╖р╕н promotions р╣Ар╕Юр╕╖р╣Ир╕нр╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Б Subquery р╕Лр╣Йр╕│
## 7.2. р╕Бр╕▓р╕гр╕кр╕░р╕кр╕бр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕Бр╕▓р╕гр╕Бр╕гр╕нр╕Зр╣Ар╕бр╕Щр╕╣
##### р╣Др╕Яр╕ер╣М: agent_setup.py (р╣Гр╕Щ AGENT_PREFIX р╕кр╣Ир╕зр╕Щ C. р╕Бр╕▓р╕гр╣Бр╕Щр╕░р╕Щр╕│р╣Ар╕бр╕Щр╕╣)
* Agent р╕Цр╕╣р╕Бр╕кр╕▒р╣Ир╕Зр╣Гр╕лр╣Й р╕нр╣Ир╕▓р╕Щр╣Бр╕ер╕░р╕гр╕зр╕Ър╕гр╕зр╕бр╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Фр╕Фр╣Йр╕▓р╕Щр╕зр╕▒р╕Хр╕Цр╕╕р╕Фр╕┤р╕Ър╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф р╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣Ир╣Гр╕Щ chat_history (Memory)
* р╣Ар╕бр╕╖р╣Ир╕нр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╣Ар╕Юр╕┤р╣Ир╕бр╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Фр╣Гр╕лр╕бр╣И (р╣Ар╕Кр╣Ир╕Щ "р╣Др╕бр╣Ир╕Чр╕▓р╕Щр╣Ар╕Щр╕╖р╣Йр╕н" р╕лр╕ер╕▒р╕З "р╣Др╕бр╣Ир╕Чр╕▓р╕Щр╕Чр╕░р╣Ар╕е") Agent р╕Ир╕░р╕Хр╣Йр╕нр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З SQL р╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕В AND T1.menu_id NOT IN (SELECT...) р╕лр╕ер╕▓р╕вр╕Кр╕▒р╣Йр╕Щ р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╣Бр╕Щр╣Ир╣Гр╕Ир╕зр╣Ир╕▓р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕вр╕Ир╕░р╕Бр╕гр╕нр╕Зр╕Чр╕╕р╕Бр╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Фр╕Чр╕╡р╣Ир╕кр╕░р╕кр╕бр╕бр╕▓

# 8. р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Ыр╕▒р╕Нр╕лр╕▓ Rate Limit р╣Бр╕ер╕░ Quota
##### р╕гр╕░р╕Ър╕Ър╕Щр╕╡р╣Йр╕бр╕╡р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Ар╕Ър╕╖р╣Йр╕нр╕Зр╕Хр╣Йр╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ыр╕▒р╕Нр╕лр╕▓р╕Бр╕▓р╕гр╕Ир╕│р╕Бр╕▒р╕Фр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Ир╕▓р╕Б API р╕Фр╕▒р╕Зр╕Щр╕╡р╣Й:
р╕Ыр╕▒р╕Нр╕лр╕▓ | р╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╕Ир╕▒р╕Фр╕Бр╕▓р╕г | р╕Бр╕ер╕вр╕╕р╕Чр╕Шр╣Мр╕Чр╕╡р╣Ир╣Гр╕Кр╣Й
----- | ----- | -----
Gemini Rate Limit (429/503) | ai_processor.py | Exponential Backoff: р╕бр╕╡ Logic р╣Гр╕Щр╕Бр╕▓р╕гр╕лр╕Щр╣Ир╕зр╕Зр╣Ар╕зр╕ер╕▓р╣Бр╕ер╕░ Retry р╕Др╕│р╕Вр╕нр╣Др╕Ыр╕вр╕▒р╕З Gemini API р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤ (р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ MAX_RETRIES р╣Бр╕ер╕░ BASE_WAIT_TIME р╣Гр╕Щр╣Вр╕Др╣Йр╕Ф)
р╕Ыр╕гр╕░р╕кр╕┤р╕Чр╕Шр╕┤р╕ар╕▓р╕Ю LLM| .env р╣Бр╕ер╕░ agent_setup.py | Model Choice: р╣Бр╕Щр╕░р╕Щр╕│р╣Гр╕лр╣Йр╣Гр╕Кр╣Й LLM_MODEL="gemini-2.5-flash" р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╣Ар╕гр╣Зр╕зр╣Бр╕ер╕░р╕Ыр╕гр╕░р╕кр╕┤р╕Чр╕Шр╕┤р╕ар╕▓р╕Юр╕Вр╕нр╕Зр╣Вр╕Др╕зр╕Хр╕▓

# 9. р╕Бр╕▓р╕гр╕нр╕▒р╕Ыр╣Ар╕Фр╕Х LINE Webhook р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
р╕гр╕░р╕Ър╕Ър╕Вр╕нр╕Зр╣Ар╕гр╕▓р╕нр╕нр╕Бр╣Бр╕Ър╕Ър╕бр╕▓р╣Ар╕Юр╕╖р╣Ир╕нр╕ер╕Фр╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Webhook р╣Гр╕Щ LINE Developers Console р╣Вр╕Фр╕вр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ update_line_webhook р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н Channel р╕Вр╕нр╕Зр╕гр╣Йр╕▓р╕Щр╕Др╣Йр╕▓р╣Ар╕Вр╣Йр╕▓р╕Бр╕▒р╕Ър╕гр╕░р╕Ър╕Ър╕лр╕ер╕▒р╕Зр╕Ър╣Йр╕▓р╕Щ (Backend) р╕Вр╕нр╕Зр╣Ар╕гр╕▓р╣Вр╕Фр╕вр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
##### 1. р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕лр╕ер╕▒р╕Б: update_line_webhook
р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф | р╕Бр╕ер╣Др╕Бр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ 
----- | ----- 
р╕зр╕▒р╕Хр╕Цр╕╕р╕Ыр╕гр╕░р╕кр╕Зр╕Др╣М | р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Ыр╕ер╕▓р╕вр╕Чр╕▓р╕З (Endpoint) р╕Чр╕╡р╣И LINE р╕Ир╕░р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ир╕▓р╕Бр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╣Ар╕Вр╣Йр╕▓р╕бр╕▓р╣Гр╕лр╣Йр╕гр╕░р╕Ър╕Ър╕Вр╕нр╕Зр╣Ар╕гр╕▓р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е 
р╕Юр╕▓р╕гр╕▓р╕бр╕┤р╣Ар╕Хр╕нр╕гр╣М | р╕гр╕▒р╕Ъ access_token (Channel Access Token) р╣Бр╕ер╕░ webhook_url (URL р╕Чр╕╡р╣Ир╕гр╕░р╕Ър╕Ър╕Вр╕нр╕Зр╣Ар╕гр╕▓р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╕╢р╣Йр╕Щ)
р╕Бр╕ер╣Др╕Б API | р╕кр╣Ир╕Зр╕Др╕│р╕Вр╕нр╣Бр╕Ър╕Ъ PUT р╣Др╕Ыр╕вр╕▒р╕З LINE Messaging API Endpoint (https://api.line.me/v2/bot/channel/webhook/endpoint) р╕Юр╕гр╣Йр╕нр╕бр╣Бр╕Щр╕Ъ Access Token р╣Гр╕Щ Header р╣Ар╕Юр╕╖р╣Ир╕нр╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕кр╕┤р╕Чр╕Шр╕┤р╣М
р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М | р╕лр╕▓р╕Бр╕кр╕│р╣Ар╕гр╣Зр╕И (р╕кр╕Цр╕▓р╕Щр╕░ 200 OK) LINE Channel р╕Ир╕░р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Др╕Ыр╕Кр╕╡р╣Й Webhook URL р╕бр╕▓р╕Чр╕╡р╣Ир╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣Мр╕Вр╕нр╕Зр╣Ар╕гр╕▓р╕Чр╕▒р╕Щр╕Чр╕╡
##### 2. Flow р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ: р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Webhook р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щ | р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╣Бр╕ер╕░р╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕З | р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Чр╕╡р╣Ир╣Др╕Фр╣Й
----- | ----- | -----
1.р╕Ыр╣Йр╕нр╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е | р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Бр╕гр╕нр╕Б Channel Secret р╣Бр╕ер╕░ Access Token р╣Гр╕Щ Frontend (р╕лр╕Щр╣Йр╕▓р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓) р╣Бр╕ер╕░р╕Др╕ер╕┤р╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Б | р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е Credentials р╕Ьр╣Ир╕▓р╕Щ POST Request р╣Др╕Ыр╕вр╕▒р╕З Backend Endpoint: /save_credentials/[user_id]
2.р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╣Бр╕ер╕░р╕кр╕гр╣Йр╕▓р╕З URL| р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ save_credentials р╣Гр╕Щ Backend (api_app.py) р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б Credentials р╕ер╕Зр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е р╣Бр╕ер╕░ р╕кр╕гр╣Йр╕▓р╕З Webhook URL р╣Ар╕Йр╕Юр╕▓р╕░р╕гр╣Йр╕▓р╕Щ (р╣Ар╕Кр╣Ир╕Щ https://[BASE_URL]/webhook/[user_id]) | Webhook URL р╕Чр╕╡р╣Ир╣Др╕бр╣Ир╕Лр╣Йр╕│р╕Бр╕▒р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ъ Channel р╕Щр╕▒р╣Йр╕Щр╕Цр╕╣р╕Бр╕кр╕гр╣Йр╕▓р╕Зр╕Вр╕╢р╣Йр╕Щ
3.р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х Webhook| Backend р╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Йр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ update_line_webhook р╕кр╣Ир╕З Access Token р╣Бр╕ер╕░ Webhook URL р╕Чр╕╡р╣Ир╕кр╕гр╣Йр╕▓р╕Зр╕Вр╕╢р╣Йр╕Щр╣Др╕Ы | LINE API р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х Webhook URL р╕Вр╕нр╕З Channel р╕Щр╕▒р╣Йр╕Щр╣Гр╕лр╣Йр╕Кр╕╡р╣Йр╕бр╕▓р╕Чр╕╡р╣Ир╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣Мр╕Вр╕нр╕Зр╣Ар╕гр╕▓
4.р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Ьр╕е| Backend р╕гр╕▒р╕Ър╕кр╕Цр╕▓р╕Щр╕░р╕кр╕│р╣Ар╕гр╣Зр╕Ир╕Ир╕▓р╕Б LINE р╣Бр╕ер╕░р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Юр╕гр╣Йр╕нр╕бр╣Бр╕кр╕Фр╕З Webhook URL р╕Чр╕╡р╣Ир╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╣Бр╕ер╣Йр╕зр╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕Чр╕╡р╣И Frontend | р╕гр╕░р╕Ър╕Ър╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Чр╕▒р╕Щр╕Чр╕╡р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕гр╕▒р╕Ъ-р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б

р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╣Бр╕Ър╕Ър╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤р╕Щр╕╡р╣Йр╕Чр╕│р╣Гр╕лр╣Йр╕бр╕▒р╣Ир╕Щр╣Гр╕Ир╣Др╕Фр╣Йр╕зр╣Ир╕▓р╣Ар╕бр╕╖р╣Ир╕нр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕е API р╣Ар╕Вр╣Йр╕▓р╕бр╕▓ р╕гр╕░р╕Ър╕Ър╕Ир╕░р╕Чр╕│р╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ LINE Channel р╣Гр╕лр╣Йр╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕гр╕▒р╕Ъ-р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Вр╕Фр╕в р╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Фр╣Йр╕зр╕вр╕Хр╕Щр╣Ар╕нр╕З р╣Гр╕Щ LINE Developer Console р╕нр╕╡р╕Бр╕Хр╣Ир╕нр╣Др╕Ы