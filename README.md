# LINE Bot Flask with AI Agent V2
р╣Вр╕Ыр╕гр╣Ар╕Ир╕Др╕Щр╕╡р╣Йр╕Др╕╖р╕нр╕Ър╕нр╕Чр╕нр╕▒р╕Ир╕Йр╕гр╕┤р╕вр╕░р╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Вр╕бр╣Ар╕Фр╕ер╕ар╕▓р╕йр╕▓р╕Вр╕Щр╕▓р╕Фр╣Гр╕лр╕Нр╣И (LLM) р╕нр╕вр╣Ир╕▓р╕З Google Gemini р╕гр╣Ир╕зр╕бр╕Бр╕▒р╕Ър╣Ар╕Яр╕гр╕бр╣Ар╕зр╕┤р╕гр╣Мр╕Б LangChain р╣Ар╕Юр╕╖р╣Ир╕нр╕Чр╕│р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щ AI Agent р╣Гр╕Щр╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Бр╕ер╕░р╕Хр╕нр╕Ър╕Др╕│р╕Цр╕▓р╕бр╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Бр╕▒р╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓/р╕Ър╕гр╕┤р╕Бр╕▓р╕гр╕Вр╕нр╕Зр╕гр╣Йр╕▓р╕Щр╕Др╣Йр╕▓ р╣Вр╕Фр╕вр╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е SQL (SQLite) р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╣Йр╕Щр╕лр╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕бр╕Щр╕╣ р╣Вр╕Ыр╕гр╣Вр╕бр╕Кр╕▒р╕Щ р╕Фр╣Йр╕зр╕вр╕Хр╕▒р╕зр╣Ар╕нр╕З р╕Юр╕гр╣Йр╕нр╕бFlaskAPI р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ LINE Messaging API р╣Вр╕Фр╕вр╕Ир╕░р╕Чр╕│р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щ Webhook р╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕▒р╕Ъ-р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б р╣Бр╕ер╕░р╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕е Channel API р╕ер╕Зр╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е SQLite р╣Др╕Фр╣Й

# ЁЯМЯ р╕Др╕╕р╕Ур╕кр╕бр╕Ър╕▒р╕Хр╕┤р╕лр╕ер╕▒р╕Б
* SQL Access via Agent: Agent р╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╕гр╣Йр╕▓р╕Зр╣Бр╕ер╕░р╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕З SQL (SELECT, INSERT, UPDATE) р╕Бр╕▒р╕Ър╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е SQLite р╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕Ър╕Ъ Real-time
* Dynamic Context & Filtering: Agent р╕Цр╕╣р╕Бр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Гр╕лр╣Йр╕гр╕▒р╕Ъ Store ID р╣Бр╕ер╕░ Store Name р╕Хр╕▒р╣Йр╕Зр╣Бр╕Хр╣Ир╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ р╕Чр╕│р╣Гр╕лр╣Йр╕Бр╕▓р╕гр╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щ SQL р╣Бр╕бр╣Ир╕Щр╕вр╕│р╣Бр╕ер╕░р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕Бр╕▓р╕гр╕Вр╣Йр╕▓р╕бр╕гр╣Йр╕▓р╕Щр╕Др╣Йр╕▓р╣Др╕Фр╣Й
* Conversation Memory: р╣Гр╕Кр╣Й ConversationBufferMemory р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Бр╣Зр╕Ър╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓ р╕Чр╕│р╣Гр╕лр╣Й Agent р╕Ир╕Фр╕Ир╕│р╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Фр╕Вр╕нр╕Зр╕ер╕╣р╕Бр╕Др╣Йр╕▓ (р╣Ар╕Кр╣Ир╕Щ "р╣Др╕бр╣Ир╕Чр╕▓р╕Щр╣Ар╕Щр╕╖р╣Йр╕н", "р╣Бр╕Юр╣Йр╕нр╕▓р╕лр╕▓р╕гр╕Чр╕░р╣Ар╕е") р╣Бр╕ер╕░р╕гр╕зр╕бр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╣Гр╕Щр╕Бр╕▓р╕гр╕Др╣Йр╕Щр╕лр╕▓р╣Ар╕бр╕Щр╕╣р╣Др╕Фр╣Й
* API Integration: р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ LINE Messaging API р╕Ьр╣Ир╕▓р╕Щ Webhook р╣Бр╕ер╕░р╣Гр╕Кр╣Й Flask/Gunicorn р╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕нр╕Зр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╣Гр╕Щ Production

# 1. р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣М
р╣Вр╕Ыр╕гр╕Фр╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╣Бр╕ер╕░р╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╕Хр╕▓р╕бр╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕Фр╣Йр╕▓р╕Щр╕ер╣Ир╕▓р╕Зр╕Щр╕╡р╣Й:
```
тФЬтФАтФА my_app/
тФВ   тФЬтФАтФА index.html        # р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Webhook р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
тФВ   тФЬтФАтФА api_app.py        # Flask API р╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ир╕▓р╕Б LINE
тФЬтФАтФА my_app/
тФВ   тФЬтФАтФА index.html        # р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Webhook р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
тФВ   тФЬтФАтФА api_app.py        # р╣Др╕Яр╕ер╣М Flask р╕лр╕ер╕▒р╕Бр╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕▒р╕Щ Webhook
тФВ   тФЬтФАтФА admin_app.py      # Streamlit UI р╕кр╕│р╕лр╕гр╕▒р╕Ъ Admin
тФВ   тФЬтФАтФА ai_processor.py   # Logic р╕лр╕ер╕▒р╕Б: р╕гр╕▒р╕Ъ task, р╣Ар╕гр╕╡р╕вр╕Б Agent, р╕Ир╕▒р╕Фр╕Бр╕▓р╕г Error/Retry Logic
тФВ   тФЬтФАтФА database.py       # р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н SQLite, р╕Бр╕▓р╕гр╕Фр╕╢р╕З Store Info р╣Бр╕ер╕░ Chat History
тФВ   тФФтФАтФА agent_setup.py    # р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Бр╕▓р╕гр╕кр╕гр╣Йр╕▓р╕З LLM, SQL Toolkit, Memory, р╣Бр╕ер╕░ Agent Executor
тФЬтФАтФА .env                  # р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ API Key р╣Бр╕ер╕░ DB URI
тФЬтФАтФА requirements.txt      # р╕гр╕▓р╕вр╕Бр╕▓р╕гр╣Др╕ер╕Ър╕гр╕▓р╕гр╕╡р╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ
тФФтФАтФА README.md             # р╣Др╕Яр╕ер╣Мр╕Др╕╣р╣Ир╕бр╕╖р╕нр╕Щр╕╡р╣Й
```

# 2. р╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓

## 2.1. р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕Бр╣Ир╕нр╕Щр╣Ар╕гр╕┤р╣Ир╕б
* Python 3.7 р╕лр╕гр╕╖р╕нр╣Гр╕лр╕бр╣Ир╕Бр╕зр╣Ир╕▓
* pip (р╕Хр╕▒р╕зр╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Бр╕Юр╣Зр╕Бр╣Ар╕Бр╕Ир╕Вр╕нр╕З Python)
* ngrok (р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Ыр╕┤р╕Ф Local Server р╣Гр╕лр╣Йр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╣Др╕Фр╣Йр╕Ир╕▓р╕Бр╕ар╕▓р╕вр╕Щр╕нр╕Б)

## 2.2. р╕кр╕гр╣Йр╕▓р╕З Environment р╣Бр╕ер╕░р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Dependencies:
```
python -m venv venv
source venv/bin/activate  # р╕Ър╕Щ Windows р╣Гр╕Кр╣Й `venv\Scripts\activate`
```
р╣Др╕Яр╕ер╣М requirements.txt
р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Др╕ер╕Ър╕гр╕▓р╕гр╕╡р╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Фр╣Йр╕зр╕вр╕Др╕│р╕кр╕▒р╣Ир╕З:
```
pip install -r requirements.txt
```

## 2.3 р╕кр╕гр╣Йр╕▓р╕Зр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ:
р╕гр╕▒р╕Щр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ initialize_db() р╣Гр╕Щ database.py р╕лр╕гр╕╖р╕нр╣Гр╕Кр╣Йр╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕бр╕╖р╕нр╕Чр╕╡р╣Ир╕Др╕╕р╕Ур╕Цр╕Щр╕▒р╕Ф р╣Ар╕Юр╕╖р╣Ир╕нр╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М agent_db.sqlite р╕Юр╕гр╣Йр╕нр╕бр╕Хр╕▓р╕гр╕▓р╕Зр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ (stores, menu, promotions, tasks, ingredients)

## 2.4 р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ API Key
### р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Кр╕╖р╣Ир╕н .env р╣Гр╕Щр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Ър╣Др╕Яр╕ер╣М api_app.py р╣Бр╕ер╕░р╣Ар╕Юр╕┤р╣Ир╕бр╕Др╣Ир╕▓р╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щр╕ер╕Зр╣Др╕Ыр╕Фр╕▒р╕Зр╕Щр╕╡р╣Й:
```
GOOGLE_API_KEY="YOUR_GEMINI_API_KEY"
# р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╕Фр╣Йр╕зр╕в LINE API
LINE_CHANNEL_ACCESS_TOKEN="YOUR_LINE_ACCESS_TOKEN"
LINE_CHANNEL_SECRET="YOUR_LINE_CHANNEL_SECRET"
#ngrok url
BASE_URL="NGROK_URL"
```

# 3. р╕гр╕▒р╕Щр╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣Мр╣Бр╕ер╕░р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ ngrok
## 3.1 р╣Ар╕Ыр╕┤р╕Ф Terminal1 р╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕З ngrok р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Ыр╕┤р╕Ф Public URL:
```
ngrok http 9000
```
р╕Др╕╕р╕Ур╕Ир╕░р╣Др╕Фр╣Йр╕гр╕▒р╕Ъ Public URL р╕Чр╕╡р╣Ир╕Вр╕╢р╣Йр╕Щр╕Хр╣Йр╕Щр╕Фр╣Йр╕зр╕в https:// (р╣Ар╕Кр╣Ир╕Щ https://example.ngrok-free.app) р╣Вр╕Ыр╕гр╕Ф р╕Др╕▒р╕Фр╕ер╕нр╕Б URL р╕Щр╕╡р╣Йр╣Др╕зр╣Й
## 3.2 р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕кр╕│р╕Др╕▒р╕Н: р╣Ар╕Ыр╕┤р╕Фр╣Др╕Яр╕ер╣М api_app.py р╣Бр╕ер╣Йр╕зр╕Щр╕│ URL р╕Чр╕╡р╣Ир╕Др╕▒р╕Фр╕ер╕нр╕Бр╕бр╕▓р╣Др╕Ыр╕зр╕▓р╕Зр╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Др╣Ир╕▓р╕Вр╕нр╕Зр╕Хр╕▒р╕зр╣Бр╕Ыр╕г base_url р╕Хр╕▓р╕бр╣Вр╕Др╣Йр╕Фр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Фр╣Йр╕▓р╕Щр╕ер╣Ир╕▓р╕З:
```
# V V V V V V V V V V V V V V V V V V V V V V V V V V V V V V
#
# >>> р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣Ир╕кр╕│р╕Др╕▒р╕Нр╕бр╕▓р╕Б: р╣Вр╕Ыр╕гр╕Фр╕Щр╕│ Public URL р╕Ир╕▓р╕Б ngrok р╕бр╕▓р╕зр╕▓р╕Зр╕Чр╕╡р╣Ир╕Щр╕╡р╣И
#
# ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^
#
BASE_URL = "[https://example.ngrok-free.app](https://example.ngrok-free.app)" # р╕зр╕▓р╕З URL ngrok р╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Чр╕╡р╣Ир╕Щр╕╡р╣И

```
## 3.3 Terminal 2 (р╕кр╕│р╕лр╕гр╕▒р╕Ъ Flask API):
р╣Ар╕Ыр╕┤р╕Ф Terminal р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╕кр╕нр╕Зр╣Бр╕ер╕░р╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕З:
```
source venv/bin/activate 
cd my_app
python api_app.py
```

# 4. р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Ър╕Щр╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ъ
## 4.1р╣Ар╕Ыр╕┤р╕Фр╣Ар╕зр╣Зр╕Ър╣Ар╕Ър╕гр╕▓р╕зр╣Мр╣Ар╕Лр╕нр╕гр╣Мр╣Бр╕ер╣Йр╕зр╣Др╕Ыр╕Чр╕╡р╣И http://localhost:9000
## 4.2р╕Бр╕гр╕нр╕Б Channel Secret р╣Бр╕ер╕░ Channel Access Token р╕Вр╕нр╕Зр╕Др╕╕р╕У
## 4.3р╕Бр╕Фр╕Ыр╕╕р╣Ир╕б "р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Бр╕ер╕░р╕кр╕гр╣Йр╕▓р╕З Webhook"
р╕лр╕▓р╕Бр╕Чр╕╕р╕Бр╕нр╕вр╣Ир╕▓р╕Зр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З р╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ър╕Ир╕░р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕зр╣Ир╕▓ "Webhook URL updated successfully." р╕Юр╕гр╣Йр╕нр╕бр╕Бр╕▒р╕Ъ Webhook URL р╕Чр╕╡р╣Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М


# 5. Flow р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ъ (System Data Flow)
## 5.1. р╕ар╕▓р╕Юр╕гр╕зр╕б Flow р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ
###### 1. Incoming Request (LINE): р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ьр╣Ир╕▓р╕Щ LINE
###### 2. API Gateway (Flask/Gunicorn): LINE Webhook р╕кр╣Ир╕З Payload р╕бр╕▓р╕вр╕▒р╕З api_app.py
###### 3. Core Logic (ai_processor.py): р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е Task
###### 4. Context Loading (database.py): р╕Фр╕╢р╕З Store ID, Store Name, р╣Бр╕ер╕░ Chat History р╕Ир╕▓р╕Б SQLite р╣Вр╕Фр╕вр╕Хр╕гр╕З
###### 5. Agent Initialization (agent_setup.py): р╕кр╕гр╣Йр╕▓р╕З Agent р╣Вр╕Фр╕вр╣Гр╕Кр╣Й Prompt р╕Чр╕╡р╣Ир╕бр╕╡р╕Ър╕гр╕┤р╕Ър╕Ч (Store ID) р╣Бр╕ер╕░ Memory (Chat History) р╕Чр╕╡р╣Ир╣Вр╕лр╕ер╕Фр╕бр╕▓
###### 6. Agent Invocation: Agent р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б
###### 7. Response Generation: Agent р╣Бр╕Ыр╕ер╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М SQL р╣Ар╕Ыр╣Зр╕Щр╕Др╕│р╕Хр╕нр╕Ър╕ар╕▓р╕йр╕▓р╣Др╕Чр╕вр╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕бр╕┤р╕Хр╕г
###### 8. Output Response (LINE): р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕вр╕▒р╕Зр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Ьр╣Ир╕▓р╕Щ LINE

## 5.2. р╕ер╕│р╕Фр╕▒р╕Ър╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е (Sequential Steps)
Step | р╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╕Чр╕│р╕Зр╕▓р╕Щ | р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╣Бр╕ер╕░ Context
----- | ----- | -----
1.Receive Task | line_handler.py -> ai_processor.py | р╕гр╕▒р╕Ъ user_id, line_id, р╣Бр╕ер╕░ user_message
2.Load Context | database.py | ЁЯЯв р╕Фр╕╢р╕З Context р╕Бр╣Ир╕нр╕Щр╕кр╕гр╣Йр╕▓р╕З Agent: р╣Ар╕гр╕╡р╕вр╕Б get_store_info_direct(user_id) р╣Ар╕Юр╕╖р╣Ир╕нр╕лр╕▓ store_id р╣Бр╕ер╕░ store_name
3.Build Prompt | agent_setup.py | р╣Гр╕Кр╣Й store_id р╣Бр╕ер╕░ store_name р╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕бр╕▓р╕кр╕гр╣Йр╕▓р╕З AGENT_PREFIX р╣Бр╕Ър╕Ъ Dynamic р╣Ар╕Юр╕╖р╣Ир╕нр╕Ър╕▒р╕Зр╕Др╕▒р╕Ър╕Бр╕▓р╕гр╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
4.Initialize Agent | agent_setup.py | р╕кр╕гр╣Йр╕▓р╕З SQLDatabaseToolkit р╣Бр╕ер╕░ AgentExecutor р╣Вр╕Фр╕вр╣Гр╕Кр╣Й Prompt р╕Чр╕╡р╣Ир╕бр╕╡ Context р╣Бр╕ер╕░ Memory р╕Чр╕╡р╣Ир╕бр╕╡ Chat History
5.Invoke Agent | ai_processor.py | р╣Ар╕гр╕╡р╕вр╕Б agent_executor.invoke({"input": user_message})
6.SQL Execution | Agent Tools -> SQLite | Agent р╕кр╕гр╣Йр╕▓р╕З SQL р╕Чр╕╡р╣Ир╕бр╕╡ WHERE store_id = [ID] р╣Бр╕ер╕░р╕гр╕▒р╕Щр╕Бр╕▒р╕Ър╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
7.Respond | ai_processor.py -> line_handler.py | р╕кр╣Ир╕Зр╕Др╕│р╕Хр╕нр╕Ър╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕вр╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╣Гр╕лр╣Й LINE

# 6. р╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕б Memory р╣Бр╕ер╕░р╕Бр╕▓р╕гр╣Гр╕Кр╣Й Chat History р╣Гр╕Щ Agent
р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕лр╕Щр╣Ир╕зр╕вр╕Др╕зр╕▓р╕бр╕Ир╕│ (Memory) р╣Ар╕Ыр╣Зр╕Щр╕лр╕▒р╕зр╣Гр╕Ир╕кр╕│р╕Др╕▒р╕Нр╕Чр╕╡р╣Ир╕Чр╕│р╣Гр╕лр╣Й Chatbot р╕Щр╕╡р╣Йр╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Ир╕Фр╕Ир╕│р╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓р╕Чр╕╡р╣Ир╕Ьр╣Ир╕▓р╕Щр╕бр╕▓р╣Бр╕ер╕░р╕Щр╕│р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╕▒р╣Йр╕Щр╕бр╕▓р╕Ыр╕гр╕░р╕Бр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕▒р╕Фр╕кр╕┤р╕Щр╣Гр╕Ир╣Бр╕ер╕░р╕Бр╕▓р╕гр╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З SQL р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╣Бр╕ер╕░р╕Лр╕▒р╕Ър╕Лр╣Йр╕нр╕Щр╣Др╕Фр╣Й
## 6.1. р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Бр╕ер╕░р╕Бр╕▓р╕гр╣Вр╕лр╕ер╕Фр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓
р╕нр╕Зр╕Др╣Мр╕Ыр╕гр╕░р╕Бр╕нр╕Ъ | р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф | р╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╕гр╕▒р╕Ър╕Ьр╕┤р╕Фр╕Кр╕нр╕Ъ
----- | ----- | -----
Chat History Storage | р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓ (User Message р╣Бр╕ер╕░ AI Response) р╕Ир╕░р╕Цр╕╣р╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Др╕зр╣Йр╣Гр╕Щр╕Хр╕▓р╕гр╕▓р╕З tasks р╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е SQLite | database.py
Function | р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ get_chat_history_for_memory() р╣Гр╕Щ database.py р╕Ир╕░р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕вр╣Йр╕нр╕Щр╕лр╕ер╕▒р╕Зр╕Хр╕▓р╕б user_id р╣Бр╕ер╕░ line_id р╣Гр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕Чр╕╡р╣И LangChain р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г (р╕бр╕▒р╕Бр╕Ир╕░р╕Ир╕│р╕Бр╕▒р╕Фр╕Чр╕╡р╣И 8-10 р╕Др╕╣р╣Ир╕кр╕Щр╕Чр╕Щр╕▓р╕ер╣Ир╕▓р╕кр╕╕р╕Ф) | database.py
Memory Setup | р╣Гр╕Кр╣Й ConversationBufferMemory р╕Вр╕нр╕З LangChain р╣Ар╕Юр╕╖р╣Ир╕нр╕Ир╕▒р╕Фр╣Ар╕Бр╣Зр╕Ър╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Чр╕╡р╣Ир╣Вр╕лр╕ер╕Фр╕бр╕▓р╕Ир╕▓р╕Бр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕зр╣Йр╣Гр╕Щр╕Хр╕▒р╕з Agent | agent_setup.py
## 6.2. р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕лр╕Щр╣Ир╕зр╕вр╕Др╕зр╕▓р╕бр╕Ир╕│р╣Ар╕Юр╕╖р╣Ир╕нр╕кр╕░р╕кр╕бр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕Бр╕гр╕нр╕З
р╕Бр╕▓р╕гр╣Гр╕Кр╣Й Memory р╣Гр╕Щр╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣Мр╕Щр╕╡р╣Йр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕бр╕╡р╣Ар╕Юр╕╡р╕вр╕Зр╣Бр╕Др╣Ир╕Бр╕▓р╕гр╕Ир╕Фр╕Ир╕│р╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ р╣Бр╕Хр╣Ир╣Ар╕Ыр╣Зр╕Щр╕Бр╕▓р╕г р╕Ър╕▒р╕Зр╕Др╕▒р╕Ъ Agent р╣Гр╕лр╣Йр╕гр╕зр╕бр╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Фр╕лр╕ер╕▓р╕вр╕Кр╕▒р╣Йр╕Щ р╣Ар╕Вр╣Йр╕▓р╕Фр╣Йр╕зр╕вр╕Бр╕▒р╕Щр╕Бр╣Ир╕нр╕Щр╕Ир╕░р╕гр╕▒р╕Щ SQL:
###### 1.р╕Бр╕▓р╕гр╕нр╣Ир╕▓р╕Щ History: р╣Гр╕Щр╣Др╕Яр╕ер╣М agent_setup.py р╕кр╣Ир╕зр╕Щ initialize_sql_agent р╕Ир╕░р╕бр╕╡р╕Бр╕▓р╕гр╣Вр╕лр╕ер╕Ф chat_history р╣Бр╕ер╕░р╕кр╣Ир╕Зр╣Ар╕Вр╣Йр╕▓р╣Гр╕Щ memory
###### 2.р╕Бр╕▓р╕гр╕Щр╕│р╣Др╕Ыр╣Гр╕Кр╣Йр╣Гр╕Щ Prompt: AGENT_PREFIX р╕Цр╕╣р╕Бр╣Ар╕Вр╕╡р╕вр╕Щр╕Вр╕╢р╣Йр╕Щр╣Ар╕Юр╕╖р╣Ир╕нр╕кр╕▒р╣Ир╕Зр╣Гр╕лр╣Й Agent р╕Хр╣Йр╕нр╕Зр╕нр╣Ир╕▓р╕Щ р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Гр╕Щ chat_history р╕Чр╕╕р╕Бр╕Др╕гр╕▒р╣Йр╕Зр╕Чр╕╡р╣Ир╕бр╕╡р╕Бр╕▓р╕гр╕Вр╕нр╣Бр╕Щр╕░р╕Щр╕│р╣Ар╕бр╕Щр╕╣
###### 3.р╕Бр╕▓р╕гр╕кр╕░р╕кр╕б Logic: р╣Ар╕бр╕╖р╣Ир╕нр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Хр╕нр╕Ър╕зр╣Ир╕▓ "р╣Др╕бр╣Ир╕Чр╕▓р╕Щр╕Чр╕░р╣Ар╕е" р╣Бр╕ер╣Йр╕зр╕Хр╕▓р╕бр╕Фр╣Йр╕зр╕в "р╣Др╕бр╣Ир╕Чр╕▓р╕Щр╣Ар╕Щр╕╖р╣Йр╕н" Agent р╕Ир╕░р╣Ар╕лр╣Зр╕Щр╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Фр╕Чр╕▒р╣Йр╕Зр╕кр╕нр╕Зр╣Гр╕Щ Memory р╣Бр╕ер╕░р╕Цр╕╣р╕Бр╕Ър╕▒р╕Зр╕Др╕▒р╕Ър╣Гр╕лр╣Йр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕кр╕нр╕Зр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╣Ар╕Вр╣Йр╕▓р╕Фр╣Йр╕зр╕вр╕Бр╕▒р╕Щр╣Гр╕Щр╕Др╕│р╕кр╕▒р╣Ир╕З SQL р╣Ар╕Фр╕╡р╕вр╕з р╣Ар╕Кр╣Ир╕Щ:
```
... WHERE T1.store_id = {store_id} 
AND T1.menu_id NOT IN (SELECT menu_id FROM ingredients WHERE ingredient_name LIKE '%р╕Чр╕░р╣Ар╕е%') 
AND T1.menu_id NOT IN (SELECT menu_id FROM ingredients WHERE ingredient_name LIKE '%р╣Ар╕Щр╕╖р╣Йр╕н%')
```